<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Private Audio Call</title>
</head>
<body>
  <h2>Private Audio Call</h2>
  <button id="call">Start Call</button>
  <audio id="remote" autoplay></audio>

  <script>
const SIGNAL_URL = "wss://chat-2u5f.onrender.com";
let pc, ws;
let readyToCall = false;

document.getElementById("call").onclick = async () => {
  ws = new WebSocket(SIGNAL_URL);

  ws.onopen = () => console.log("Connected to signaling server");

  ws.onmessage = async e => {
    let data;
    if (typeof e.data === "string") {
      data = e.data;
    } else if (e.data instanceof Blob) {
      data = await e.data.text();
    } else return;

    const msg = JSON.parse(data);

    if (msg.type === "peers" && msg.count === 2 && !readyToCall) {
      console.log("Both peers connected, starting WebRTC");
      readyToCall = true;
      startWebRTC();
    }

    if (msg.sdp) {
      await pc.setRemoteDescription(msg.sdp);
      if (msg.sdp.type === "offer") {
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ sdp: pc.localDescription }));
      }
    }

    if (msg.ice) {
      await pc.addIceCandidate(msg.ice);
    }
  };
};

async function startWebRTC() {
  pc = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" } // public STUN
    ]
  });

  pc.ontrack = e => {
    console.log("Remote track received");
    document.getElementById("remote").srcObject = e.streams[0];
  };

  pc.onicecandidate = e => {
    if (e.candidate) ws.send(JSON.stringify({ ice: e.candidate }));
  };

  pc.oniceconnectionstatechange = () => console.log("ICE state:", pc.iceConnectionState);
  pc.onconnectionstatechange = () => console.log("Connection state:", pc.connectionState);

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  stream.getTracks().forEach(t => pc.addTrack(t, stream));

  const offer = await pc.createOffer({ offerToReceiveAudio: true });
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({ sdp: pc.localDescription }));
}
</script>
</body>
</html>
